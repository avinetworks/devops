#
# @author: Gaurav Rastogi (grastogi@avinetworks.com)
#
# This playbook takes a list of comma separated pool servers
# and adds or remove them and enable disables them to existing Pool
# Usage:
#   ansible-playbook main.yaml --extra-vars "username=admin password=password controller=10.206.114.133 pool_name=Test-Pool pool_servers=10.10.10.10,20.20.20.20 patch_op=add enabled=true"
#

---
- hosts: localhost
  connection: local
  vars:
    avi_credentials:
      controller: "{{ controller }}"
      username: "{{ username }}"
      password: "{{ password }}"
    pool_name: "{{ pool_name }}"
    pool_servers: "{{ pool_servers }}"
    patch_op: "{{ patch_op }}"
    servers: servers
    enabled: "{{ enabled }}"
  roles:
    - role: avinetworks.avisdk
  tasks:
    - name: build server list
      set_fact:
        servers_list: "{{ servers_list|default([]) + [{'ip': {'addr': item, 'type': 'V4'}, 'enabled': enabled | bool}] }}"
      with_items: "{{ pool_servers.split(',') }}"
      # each server_list item has ansible fact as server
    # - debug: var=servers_list
    - avi_api_session:
        # get pool information
        avi_credentials: "{{ avi_credentials }}"
        http_method: get
        path: pool
        params:
          name: "{{ pool_name }}"
      register: pool_results
    - name: get_pool_path
      set_fact:
        pool_path: "pool/{{ pool_results.obj.results[0].uuid }}"
    - name: get patch data
      set_fact:
        patch_data: "{
          \"{{ patch_op }}\": {
            \"servers\": {{ servers_list }}
            }
          }"
    - debug:
        msg: "{{ patch_data }}"
    - avi_api_session:
        avi_credentials: "{{ avi_credentials }}"
        http_method: patch
        path: "{{ pool_path }}"
        data: "{{ patch_data }}"
